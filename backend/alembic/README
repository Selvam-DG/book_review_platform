# Alembic Database Migrations

This project uses **Alembic** for managing database schema migrations for the
Book Review Platform backend.

Alembic allows us to version, track, upgrade, and downgrade database schema
changes in a controlled and reproducible way.

---

## Directory Structure

```text
alembic/
├── versions/              # All migration scripts (versioned)
├── env.py                 # Alembic runtime configuration
├── script.py.mako         # Migration file template
└── README.md              # This file
````

---

##  Configuration

Alembic is configured to use the same database connection as the backend.

* Database URL is dynamically loaded from environment variables
* `env.py` imports SQLAlchemy `Base.metadata` for autogeneration

```python
from db import make_db_uri
from models import Base

config.set_main_option("sqlalchemy.url", make_db_uri())
target_metadata = Base.metadata
```

---

## Common Commands

### Check current migration version

```bash
alembic current
```

### View migration history

```bash
alembic history
```

### Show current heads

```bash
alembic heads
```

---

##  Creating a New Migration

After modifying SQLAlchemy models:

```bash
alembic revision --autogenerate -m "describe your change"
```
 **Always review the generated file** before upgrading.

---

## ⬆Apply Migrations

Upgrade database to the latest version:

```bash
alembic upgrade head
```

Upgrade one step:

```bash
alembic upgrade +1
```

---

## Rollback (Downgrade)

Downgrade one revision:

```bash
alembic downgrade -1
```

Downgrade to a specific revision:

```bash
alembic downgrade <revision_id>
```

---

## Handling Multiple Heads

If Alembic reports **multiple heads**, merge them:

```bash
alembic merge heads -m "merge migration heads"
alembic upgrade head
```

This does **not change schema**, only fixes migration history.

---

## Best Practices

* Never edit applied migrations in production
* Always commit migration files with model changes
* Use **small, focused migrations**
* Merge heads instead of deleting files
* Review autogenerated migrations carefully

---

## Notes

* Migrations are transactional (PostgreSQL)
* All schema changes must go through Alembic
* Do NOT use `Base.metadata.create_all()` in production

---

## Migration Workflow Summary

```text
Edit models → autogenerate → review → upgrade → commit
```

---

Happy migrating



